## Тестовый проект bigquery-dbt

### В ходе выполнения тестового проекта, на первом шаге была развёрнута инфраструктура в Yandex Cloud  
* запущена виртуальная машина на базе Linux Ubuntu
* прописаны права доступа в политиках облачного файервола
* созданы и загружены ssh ключи для ВМ
* установлен git, pip
* сгенерированы и загружены ssh ключи для доступа с ВМ на удаленный репозиторий
* создано окружение проекта
* установлен dbt-bigquery адаптер с зависимостями
* произведена инициализация проекта (dbt init)

### Вторым шагом в GCP console был создан новый проект
* был создан сервисный аккаунт для доступа dbt к проекту
* сервисному аккаунту были назначены политики доступа (IAM)
* получены credantials
* в папке проекта был создан датасет в котором будут создаваться таблицы моделей
* датасет был размещен в той же локации, что и публичный датасет (US), чтобы исключить ошибку прав доступа 
* на основе настроек проекта в GCP и credantials были заполнены profiles.yml и dbt-project.yml проекта
* протестировано соединение с GCP (dbt debug)

### На третьем шаге была произведена основная работа в проекте
* написан код для запросов моделей
* блоки СTE были разнесены по трём разным моделям
* создано описание схемы для source-модели (source.yml)
* создано описание схемы для промежуточной и итоговой моделей (schema.yml)
* создана тестовая модель для инкрементальной загрузки данных с источника

### Описание файлов моделей

_src_taxi_trips_select.sql_ - модель формирует таблицу-источник, на который будут ссылаться все downstream-модели. Данные берем с апреля 2018 по текущий момент, дополнительно фильтруем только те поездки, в который присутствовали чаевые

_int_top3_taxi.sql_ - промежуточная модель, которая считает топ-3 такси по полученным чаевым в апреле 2018 года.

_rep_top3_taxi_tips_by_month.sql_ - итоговая модель, которая выводит помесячную детализацию полученных чаевых с подсчетом изменения чаевых по каждой машине из топ-3 в %,  месяц к месяцу. 

_src_taxi_trips_incremantal.sql_ - тестовая модель с инкрементальной загрузкой таблицы источника на основе поля начала поездки trip_start_timestamp

Сначала запускаем нашу модель с флагом --full refresh, что вызовет первичную загрузку данных.
Потом запускаем эту же модель без доп.флагов, чтобы вызвать загрузку только инкремента.

### Warnings
Прим. т.к. тестовый датасет chicago_taxi_trips довольно вылик по объему, существует риск выхода за бесплатные лимиты по хранению и байтам при выполнении модели с флагом full refresh !!!

#### Выгрузку итоговой таблицы можно посмотреть по ссылке: [Тыц](https://docs.google.com/spreadsheets/d/15tUqtdvALx8usRwf0sS3l-EnsfRKvqBrx73WGvg-X4Q/edit?usp=sharing)    
